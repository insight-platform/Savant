version: "3.3"
services:

  image-json-source:
    image: ghcr.io/insight-platform/savant-adapters-gstreamer:latest
    restart: unless-stopped
    volumes:
      - zmq_sockets:/tmp/zmq-sockets
      - ../../data/modules/json_input:/data/
    environment:
      - READ_METADATA=TRUE
      - ZMQ_ENDPOINT=req+connect:ipc:///tmp/zmq-sockets/input.ipc
      - SOURCE_ID=coco-images1
      - LOCATION=/data
      - FILE_TYPE=picture
    entrypoint: /opt/savant/adapters/gst/sources/media_files.sh

  module:
    build:
      context: .
      dockerfile: docker/Dockerfile.x86
    restart: unless-stopped
    volumes:
#      - /tmp/zmq_sockets:/tmp/zmq-sockets
      - ../../savant:/usr/local/lib/python3.8/dist-packages/savant
      - zmq_sockets:/tmp/zmq-sockets
#      - ../../models/peoplenet_detector:/models
#      - ../../downloads/peoplenet_detector:/downloads
      - ..:/opt/savant/samples
    command: samples/json_input/demo.yml
    environment:
      - ZMQ_SRC_ENDPOINT=rep+bind:ipc:///tmp/zmq-sockets/input.ipc
      - ZMQ_SINK_ENDPOINT=pub+bind:ipc:///tmp/zmq-sockets/output.ipc
      - FPS_PERIOD=1000
      - LOGLEVEL=INFO
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  image-json-sink:
    image: ghcr.io/insight-platform/savant-adapters-py:latest
    restart: unless-stopped
    volumes:
      - zmq_sockets:/tmp/zmq-sockets
      - ../../data/res:/results
    environment:
      - ZMQ_ENDPOINT=sub+connect:ipc:///tmp/zmq-sockets/output.ipc
      - CHUNK_SIZE=1000
      - DIR_LOCATION=/results/%source_id
    entrypoint: /opt/savant/adapters/python/sinks/image_files.py


volumes:
  zmq_sockets:
